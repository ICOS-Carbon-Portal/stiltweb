<!DOCTYPE html>
<html lang="en">
<head>
	<link href="https://static.icos-cp.eu/constant/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet"/>
	<script src="http://code.jquery.com/jquery-2.0.0.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/dygraph/1.1.1/dygraph-combined.js"></script>

	<meta charset="UTF-8">
	<title>Select input to STILT</title>

	<style type="text/css">
		.navbar-default {
			background-color: #414042;
			border-color: #414042;
		}

		.navbar-default span, .navbar-default p, .navbar-default h1 {
			color: #ffffff;
		}

		.paddedTD {
			padding: 10px
		}
	</style>

</head>
<body>
<nav class="navbar navbar-default navbar-static-top">
	<div class="container-fluid">
		<div class="navbar-header">
			<a href="https://www.icos-ri.eu">
				<img alt="Carbon Portal" src="https://static.icos-cp.eu/images/Icos_Logo_RGB_White_Carbon_Portal_80px.png">
			</a>
		</div>
		<h1>STILT Footprints</h1>
	</div>
</nav>
<div id="startSILTDiv">
	<div class="container-fluid" id="stations">
		<div class="row">
			<div class="col-md-8">
					<label for="site">Select dataset to use as input to STILT</label><br />
					<select id="site">
						<option value="CB4">CB4</option>
						<option value="HEI">HEI</option>
						<option value="MHD">MHD</option>
					</select>

					<div>
						<button onclick="startStilt()">Start</button>
					</div>
			</div>
		</div>

	</div>
</div>
<div id="visualizationDIV" hidden>
	<div class="panel panel-default" id="graphsHeader">
		<div class="panel-heading">
			<h3 class="panel-title"></h3>
		</div>
	</div>
	<div>
		<table>
			<tr>
				<td class="paddedTD">
					<div>
						<div class="panel panel-default" id="STILTCO2MoleFraction">
							<div class="panel-heading">
								<h3 class="panel-title">STILT-modelled CO2 mole fraction</h3>
							</div>
							<div id="STILTCO2MoleFractionGraph"></div>
						</div>
					</div>
				</td>
				<td class="paddedTD">
					<div>
						<div class="panel panel-default" id="bioFuelCO2">
							<div class="panel-heading">
								<h3 class="panel-title">Biospheric and fuel CO2 contributions</h3>
							</div>
							<div id="bioFuleCO2Graph"></div>
						</div>
					</div>
				</td>
				<td class="paddedTD">
					<div>
						<div class="panel panel-default" id="BoundHeightandRadon">
							<div class="panel-heading">
								<h3 class="panel-title">Boundary layer height and 222Radon</h3>
							</div>
							<div id="BoundHeightandRadonGraph"></div>
						</div>
					</div>
				</td>
			</tr>
		</table>
		<div class="panel panel-default" id="checkboxDiv">
			<div class="panel-heading">
				<h3 class="panel-title"></h3>
			</div>
			<label class="checkbox-inline"><input type="checkbox" class="footprint" value="co2.total"/>co2.total<br/></label>
			<label class="checkbox-inline"><input type="checkbox" class="footprint" value="co2.bio"/>co2.bio<br/></label>
			<label class="checkbox-inline"><input type="checkbox" class="footprint" value="gee.all"/>gee.all<br/></label>
			<label class="checkbox-inline"><input type="checkbox" class="footprint" value="resp.all"/>resp.all<br/></label>
			<label class="checkbox-inline"><input type="checkbox" class="footprint" value="co2.fuel"/>co2.fuel<br/></label>
			<label class="checkbox-inline"><input type="checkbox" class="footprint" value="co2.cat.fuel.oil"/>co2.cat.fuel.oil<br/></label>
			<label class="checkbox-inline"><input type="checkbox" class="footprint" value="co2.cat.fuel.coal"/>co2.cat.fuel.coal<br/></label>
			<label class="checkbox-inline"><input type="checkbox" class="footprint" value="co2.cat.fuel.gas"/>co2.cat.fuel.gas<br/></label>
			<label class="checkbox-inline"><input type="checkbox" class="footprint" value="co2.cat.fuel.bio"/>co2.cat.fuel.bio<br/></label>
			<label class="checkbox-inline"><input type="checkbox" class="footprint" value="co2.ini"/>co2.ini<br/></label>
		</div>
		<input type="button" class="btn btn-default" onclick="drawCheckboxGraph()" value="Submit"/>
	</div>
	<br/>
	<div class="panel panel-default">
		<table>
			<tr>
				<td class="paddedTD">
					<div class="panel panel-default" id="freeGraphDivHeader">
						<div class="panel-heading">
							<h3 id="freeGraphHeader" class="panel-title"></h3>
						</div>
						<div id="freeGraphdiv"></div>
					</div>
				</td>
			</tr>
		</table>
	</div>
</div>
</body>
</html>

<script>

	function startStilt() {
		const site = JSON.stringify({
			site: $('#site option:selected').val()
		});

		const request = $.ajax({
			type: "POST",
			url: "/startStilt",
			data: site,
			contentType: 'application/json'
		});
		request.done(function () {
			setHeaderTexts();
			$('#visualizationDIV').removeAttr('hidden');
			visualize();
		})
	}

	function setHeaderTexts() {
		$('#graphsHeader h3').text('Data from ' + $('#site option:selected').val());
		$('#checkboxDiv h3').text('Choose concentrations for ' + $('#site option:selected').val());
	}

	function visualize() {
		var units = ["[ppm]"];
		var components = {
			data: ["co2.total"]
		};
		const g1 = drawGraph("STILTCO2MoleFractionGraph", JSON.stringify(components), units);

		units = ["[ppm]"];
		components = {
			data: ["co2.bio", "gee.all", "resp.all", "co2.fuel", "co2.cat.fuel.oil", "co2.cat.fuel.coal", "co2.cat.fuel.gas", "co2.cat.fuel.bio"]
		};
		const g2 = drawGraph("bioFuleCO2Graph", JSON.stringify(components), units);

		units = ["[m]", "[Bq/m2]"];
		components = {
			data: ["zi", "rn"]
		};
		const g3 = drawGraph("BoundHeightandRadonGraph", JSON.stringify(components), units);
	}

	function drawGraph(div, components, units) {
		const request = $.ajax({
			type: "POST",
			url: "/getData",
			data: components,
			dataType: 'json',
			contentType: 'application/json'
		});

		request.done(function (data) {
			drawDyghraphs(div, data.data, data.dates, data.labels, units);
		}).fail(function (ett, tva, tre) {
			console.log({ett, tva, tre});
		});
	}

	function drawDyghraphs(div, data, dates, labels, units) {
		labels.splice(0, 0, "date");

		if (units.length == 1) {
			const y1Label = units[0];

			return new Dygraph(document.getElementById(div), customZip(dates, data), {labels: labels, ylabel: y1Label, legend: "always"});
		} else {
			const yLabel = "zi - " + units[0];
			const y2Label = "rn - " + units[1];

			return new Dygraph(document.getElementById(div), customZip(dates, data), {
				labels: labels,
				series: {"rn": {axis: 'y2'}},
				ylabel: yLabel,
				y2label: y2Label,
				axisLabelWidth: 65,
				legend: "always"
			});
		}

	}

	function customZip(dateTimes, dataPoints) {
		const retArray = [];

		for (var i = 0; i < dateTimes.length; i++) {
			const tmpArray = [];
			tmpArray.push(new Date(dateTimes[i][0].replace("#", " ")));
			for (var j = 0; j < dataPoints[i].length; j++) {
				tmpArray.push(dataPoints[i][j]);
			}
			retArray.push(tmpArray);
		}
		return retArray;
	}

	function drawCheckboxGraph() {
		const cbxList = $('.footprint');
		const checkedBoxes = [];
		for (var i = 0; i < cbxList.length; i++) {
			if (cbxList[i].checked) {
				checkedBoxes.push(cbxList[i].value);
			}
		}

		const columns = {
			data: checkedBoxes
		};

		getData(JSON.stringify(columns));
	}

	function getData(footprints) {
		const request = $.ajax({
			type: "POST",
			url: "/getData",
			data: footprints,
			dataType: 'json',
			contentType: 'application/json'
		});

		request.done(function (data) {
			dygraph(data.data, data.dates, data.labels);
		}).fail(function (ett, tva, tre) {
			console.log({ett, tva, tre});
		});

	}
	function dygraph(data, dates, labels) {
		labels.splice(0, 0, "date");

		const graph = new Dygraph(document.getElementById("freeGraphdiv"), customZip(dates, data), {labels: labels, ylabel: "[ppm]", legend: "always"});
	}


</script>